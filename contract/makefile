# ================================
# ğŸš€ PERSIST STATE COMMANDS
# ================================

# Start Anvil with state dumping (saves state when stopped)
# This command starts a fresh Anvil instance that will save its state to state.json when stopped
persist-state-dump:
	@echo "ğŸ”„ Starting Anvil with state persistence..."
	@echo "ğŸ’¾ State will be saved to state.json when you stop Anvil (Ctrl+C)"
	anvil --dump-state state.json

# Start Anvil and load previous state (if exists)
# This command loads a previously saved state from state.json
persist-state-load:
	@if [ -f "state.json" ]; then \
		echo "ğŸ“‚ Loading previous state from state.json..."; \
		anvil --load-state state.json --dump-state state.json; \
	else \
		echo "ğŸ“ No previous state found (state.json), starting fresh with state persistence..."; \
		anvil --dump-state state.json; \
	fi

# Clean state file
persist-state-clean:
	@if [ -f "state.json" ]; then \
		echo "ğŸ§¹ Removing state.json..."; \
		rm state.json; \
		echo "âœ… State file cleaned"; \
	else \
		echo "ğŸ“ No state file found to clean"; \
	fi

# Show state file info
persist-state-info:
	@if [ -f "state.json" ]; then \
		echo "ğŸ“„ State file information:"; \
		ls -lh state.json; \
		echo "ğŸ“Š File size: $$(du -h state.json | cut -f1)"; \
	else \
		echo "ğŸ“ No state file found"; \
	fi

# ================================
# ğŸš€ DEPLOYMENT COMMANDS
# ================================

# Load environment variables from .env file (if it exists)
-include .env
export

# Deploy to local Anvil (requires anvil to be running)
deploy-local:
	forge script script/Deploy.s.sol:Deploy \
		--fork-url $(ANVIL_RPC_URL) \
		--private-key $(ANVIL_PRIVATE_KEY) \
		--broadcast

# Deploy to Sepolia testnet (requires SEPOLIA_RPC_URL and PRIVATE_KEY env vars)
deploy-sepolia:
	@if [ -z "$(SEPOLIA_RPC_URL)" ] || [ -z "$(PRIVATE_KEY)" ]; then \
		echo "âŒ Error: SEPOLIA_RPC_URL and PRIVATE_KEY environment variables must be set"; \
		echo "ğŸ“ Example: export SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY"; \
		echo "ğŸ“ Example: export PRIVATE_KEY=0x..."; \
		exit 1; \
	fi
	forge script script/Deploy.s.sol:Deploy \
		--fork-url $(SEPOLIA_RPC_URL) \
		--private-key $(PRIVATE_KEY) \
		--broadcast \
		--verify \
		--etherscan-api-key $(ETHERSCAN_API_KEY)

# ================================
# ğŸ› ï¸  UTILITY COMMANDS
# ================================

# Function to create .env file content (accepts filename as argument)
define create_env_content
	@echo "ğŸ“ Creating $(1) template..."
	@touch $(1)
	@echo "" >> $(1)
	@echo "# Anvil Local Development" >> $(1)
	@echo "ANVIL_RPC_URL=http://127.0.0.1:8545" >> $(1)
	@echo "ANVIL_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" >> $(1)
	@echo "" >> $(1)
	@echo "# Sepolia Testnet (fill in your values)" >> $(1)
	@echo "SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_API_KEY" >> $(1)
	@echo "PRIVATE_KEY=0xYOUR_PRIVATE_KEY" >> $(1)
	@echo "ETHERSCAN_API_KEY=YOUR_ETHERSCAN_API_KEY" >> $(1)
	@echo "âœ… $(1) file created!"
endef

# Create .env and .env.example templates (removes existing files if present)
create-env:
	@if [ -f .env ]; then \
		echo "âš ï¸  .env file already exists. Removing and recreating..."; \
		rm .env; \
	fi
	@if [ -f .env.example ]; then \
		echo "âš ï¸  .env.example file already exists. Removing and recreating..."; \
		rm .env.example; \
	fi
	$(call create_env_content,.env)
	$(call create_env_content,.env.example)
	@echo ""
	@echo "ğŸ‰ Both .env and .env.example files created!"
	@echo "ğŸ’¡ Please review and update the values in .env file."

# Check if Anvil is running
check-anvil:
	@echo "ğŸ” Checking if Anvil is running..."
	@curl -s -X POST -H "Content-Type: application/json" \
		--data '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
		$(ANVIL_RPC_URL) > /dev/null 2>&1 \
		&& echo "âœ… Anvil is running on $(ANVIL_RPC_URL)" \
		|| echo "âŒ Anvil is not running on $(ANVIL_RPC_URL)"

# Show default Anvil accounts
show-anvil-accounts:
	@echo "ğŸ”‘ Default Anvil Test Accounts:"
	@echo "Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
	@echo "Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
	@echo ""
	@echo "Account #1: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8"  
	@echo "Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
	@echo ""
	@echo "ğŸ’¡ Use Account #0 for ANVIL_PRIVATE_KEY in your .env file"

help:
	@echo "ğŸŒŠ Ocean Token Deployment Commands:"
	@echo ""
	@echo "ğŸ“¦ State Management:"
	@echo "  make persist-state-dump       # Start Anvil with state persistence"
	@echo "  make persist-state-load       # Load previous state from state.json"
	@echo "  make persist-state-clean      # Clean state.json file"
	@echo "  make persist-state-info       # Show state.json file info"
	@echo ""
	@echo "ğŸš€ Deployment:"
	@echo "  make deploy-local             # Deploy to local Anvil"
	@echo "  make deploy-sepolia           # Deploy to Sepolia testnet"
	@echo ""
	@echo "ğŸ› ï¸  Utilities:"
	@echo "  make check-anvil              # Check if Anvil is running"
	@echo "  make show-anvil-accounts      # Show default Anvil test accounts"
	@echo "  make create-env               # Create .env template file"
	@echo "  make help                     # Show this help message"
	@echo ""
	@echo "ğŸ’¡ Quick Start:"
	@echo "  1. make create-env            # Create .env file"
	@echo "  2. make persist-state-load    # Start Anvil with state persistence"
	@echo "  3. make deploy-local-verify   # Deploy contract"

.DEFAULT_GOAL := help

.PHONY: persist-state-dump persist-state-load persist-state-clean persist-state-info deploy-local deploy-local-verify deploy-sepolia check-anvil show-anvil-accounts create-env help